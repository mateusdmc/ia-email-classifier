<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI E-mails | Leitura e classificação automática de emails</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; scroll-behavior: smooth;}
        .tab-content { display: none; }
        .icon-vermais{
            display: none;
        }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .sidebar-item.active { background: #f1f5f9; color: #4f46e5; border-left: 4px solid #4f46e5; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); }
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
            .sidebar.open { transform: translateX(0); }
        }
        #confidenceBar { transition: width 1s ease-in-out; }

@media (max-width: 640px) {
    /* Esconde apenas o cabeçalho e a coluna de data/hora se necessário */
    table thead {
        display: none;
    }
    .hidden_verdetalhes{
        display: none;
    }
    .icon-vermais{
        display: block;
    }
    
    /* Reorganiza as células em um layout de card */
    table tbody tr {
        display: grid;
        grid-template-columns: 1fr auto;
        grid-template-rows: auto auto; /* Duas linhas apenas */
        grid-template-areas: 
            "remetente botao"      /* Linha 1: Remetente + Botão */
            "classificacao botao"; /* Linha 2: Classificação + Botão (continuando na mesma coluna) */
        gap: 0.5rem 1rem; /* Espaço vertical e horizontal */
        padding: 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        margin-bottom: 0.75rem;
        background-color: white;
        align-items: start; /* Alinha itens ao topo */
    }
    
    /* Remove estilos de tabela */
    table, tbody {
        display: block;
    }
    
    /* Remove espaçamento e bordas originais */
    table td {
        padding: 0 !important;
        border: none !important;
    }
    
    /* Primeira célula - Remetente/Assunto */
    table tbody td:nth-child(1) {
        grid-area: remetente;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    /* Segunda célula - Classificação (ABAIXO do remetente) */
    table tbody td:nth-child(2) {
        grid-area: classificacao;
        text-align: left;
        display: flex;
        justify-content: flex-start;
        align-items: center;
        margin-top: 0.5rem;
    }
    
    /* Terceira célula - Data/Hora (escondida) */
    table tbody td:nth-child(3) {
        display: none;
    }
    
    /* Quarta célula - Botão (ocupa ambas linhas) */
    table tbody td:nth-child(4) {
        grid-area: botao;
        display: flex;
        align-items: center; /* Centraliza verticalmente */
        justify-content: flex-end;
        height: 100%; /* Ocupa toda altura disponível */
    }
    
    /* Ajusta botão para mobile */
    .view-details {
        padding: 0.5rem 0.75rem;
        font-size: 0.7rem;
        white-space: nowrap;
    }
    
    /* Ajusta badge de classificação */
    table tbody td:nth-child(2) span[class*="bg-"] {
        padding: 0.25rem 0.75rem;
        font-size: 0.65rem;
        font-weight: bold;
        text-transform: uppercase;
        border-radius: 0.5rem;
        display: inline-block;
    }
    
    /* Remove hover effect original */
    table tbody tr:hover {
        background-color: transparent;
    }
    
    /* Adiciona hover ao card */
    table tbody tr:hover {
        background-color: #f8fafc;
        border-color: #cbd5e1;
    }
}
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900">

    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 z-30 hidden lg:hidden"></div>
    <div id="toastContainer" class="fixed top-5 right-5 z-[100] space-y-3 pointer-events-none"></div>

    <header class="lg:hidden bg-white border-b p-4 flex justify-between items-center sticky top-0 z-40">
        <div class="flex items-center gap-2 text-indigo-600 font-bold">
            <div class="w-8 h-8 bg-indigo-600 rounded flex items-center justify-center text-white text-xs">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-mail-ai"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 19h-5a2 2 0 0 1 -2 -2v-10a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v4" /><path d="M3 7l8 5.345m4 -1.345l6 -4" /><path d="M14 21v-4a2 2 0 1 1 4 0v4" /><path d="M14 19h4" /><path d="M21 15v6" /></svg>
            </div>
            <span>E-mails</span>
        </div>
        <button onclick="toggleSidebar()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"/></svg>
        </button>
    </header>

    <div class="flex min-h-screen">
        <aside id="sidebar" class="sidebar fixed w-64 h-full bg-white border-r border-slate-200 flex flex-col z-40 lg:translate-x-0">
            <div class="p-8 hidden lg:block">
                <div onclick="switchTab('dashboard')" class="flex items-center gap-2 text-indigo-600 font-bold text-2xl cursor-pointer">
                    <div class="w-9 h-9 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-mail-ai"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 19h-5a2 2 0 0 1 -2 -2v-10a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v4" /><path d="M3 7l8 5.345m4 -1.345l6 -4" /><path d="M14 21v-4a2 2 0 1 1 4 0v4" /><path d="M14 19h4" /><path d="M21 15v6" /></svg>
                    </div>
                    <span>E-mails</span>
                </div>
            </div>

            <nav class="flex-1 px-4 space-y-1 max-lg:pt-[20px]">
                <button onclick="switchTab('dashboard')" id="btn-dashboard" class="sidebar-item active w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold text-slate-500 rounded-lg hover:bg-slate-50 transition-all">
                     <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                    Análise de e-mails
                </button>
                <button onclick="switchTab('history')" id="btn-history" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold text-slate-500 rounded-lg hover:bg-slate-50 transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    Histórico Geral
                </button>
                <button onclick="switchTab('integration')" id="btn-integration" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold text-slate-500 rounded-lg hover:bg-slate-50 transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                    Integrações
                </button>
            </nav>

            <div class="p-6 border-t border-slate-100">
                <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=4f46e5&color=fff" class="w-8 h-8 rounded-lg" alt="User">
                    <div>
                        <p class="text-xs font-bold truncate">Admin Financeiro</p>
                        <p class="text-[10px] text-slate-400 truncate">Sair do sistema</p>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 lg:ml-64 p-4 md:p-8 lg:p-12">
            
            <section id="dashboard" class="tab-content active">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold">Classificação de e-mails</h1>
                    <p class="text-slate-500 mt-1 text-sm">Insira ou faça o upload de e-mails para processamento instantâneo.</p>
                </div>

                <!-- <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">E-mails Processados</p>
                        <h2 id="countTotal" class="text-3xl font-bold">0</h2>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Produtivo</p>
                        <h2 id="countProd" class="text-3xl font-bold text-emerald-500">0</h2>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Improdutivo</p>
                        <h2 id="countImp" class="text-3xl font-bold text-amber-500">0</h2>
                    </div>
                </div> -->

                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">

                    <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                        <label class="block text-sm font-bold text-slate-700 mb-4 uppercase">Entrada de Conteúdo</label>
                        <textarea id="analyzeInput" oninput="handleInputValidation()" rows="8" class="w-full bg-slate-50 border-0 rounded-xl p-4 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all disabled:opacity-50 disabled:cursor-not-allowed" placeholder="Cole o texto do e-mail aqui..."></textarea>
                        <div class="mt-6 flex flex-col sm:flex-row gap-4 items-stretch">
                            <div class="flex-1 min-h-[56px] relative">
                                <label id="fileInputLabel" class="w-full h-full border-2 border-dashed border-slate-200 rounded-2xl p-4 flex items-center justify-center gap-3 cursor-pointer hover:bg-slate-50 transition-all">
                                    <span class="text-sm font-semibold text-slate-600">Anexar .pdf ou .txt</span>
                                    <input type="file" id="fileInput" onchange="handleFileSelection()" class="hidden" accept=".pdf,.txt">
                                </label>
                                <div id="filePreview" class="hidden w-full h-full bg-indigo-50 border border-indigo-100 rounded-2xl p-4 flex items-center justify-between animate-fadeIn">
                                    <div class="flex items-center gap-3 overflow-hidden">
                                        <svg class="w-5 h-5 text-indigo-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                                        <span id="fileNameDisplay" class="text-sm font-bold text-indigo-900 truncate">arquivo.pdf</span>
                                    </div>
                                    <button onclick="removeFile()" id="btnRemoveFile" class="text-[10px] font-bold text-red-500 hover:text-red-700 uppercase tracking-widest flex-shrink-0 ml-2">Remover</button>
                                </div>
                            </div>
                            <button onclick="realAnalysis()" id="btnAnalisar" class="px-10 py-4 bg-indigo-600 text-white rounded-2xl font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 active:scale-95">
                                Analisar com IA
                            </button>
                            <button onclick="resetAnalysis()" id="btnNovaAnalise" class="hidden px-10 py-4 bg-emerald-600 text-white rounded-2xl font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 active:scale-95">
                                Nova Analise
                            </button>
                        </div>
                    </div>


                    <div id="resultCard" class="bg-slate-900 rounded-3xl p-8 text-white relative transition-all opacity-50">
                        <div class="absolute top-0 right-0 p-8 opacity-10">
                            <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </div>
                        
                        <h2 class="text-xl font-bold mb-8 flex items-center gap-3">
                            <span id="resultPulse" class="w-2 h-2 bg-[#94a3b8] rounded-full"></span> Diagnóstico da IA
                        </h2>

                        <div class="space-y-8">
                            <div>
                                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em] mb-3">Classificação do e-mail</p>
                                <span id="categoryBadge" class="px-5 py-2 bg-slate-800 text-slate-400 rounded-full text-xs font-bold border border-white/10 italic">Aguardando entrada...</span>
                            </div>

                            <div>
                                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em] mb-3">Sugestão de resposta</p>
                                <div id="aiResponseText" contenteditable="false" class="bg-white/5 border border-white/10 rounded-2xl p-6 text-slate-400 text-sm italic outline-none focus:ring-1 focus:ring-indigo-500 transition-all">
                                    "O resultado aparecerá aqui..."
                                </div>
                            </div>

                            <div class="pt-4 border-t border-white/10 flex flex-wrap gap-3">
                                <button onclick="copyResponse()" class="flex-1 bg-white text-slate-900 py-3 px-4 rounded-xl font-bold hover:bg-slate-200 transition-all text-sm">Copiar resposta</button>
                                <button id="btnEditResponse" onclick="toggleEdit()" class="flex-1 bg-indigo-600 text-white py-3 px-4 rounded-xl font-bold hover:bg-indigo-700 transition-all text-sm">Editar resposta</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="history" class="tab-content">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold">Histórico Geral</h1>
                    <p class="text-slate-500 mt-1 text-sm">Registro geral de todas as atividades processadas.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">E-mails Processados</p>
                        <h2 id="countTotal" class="text-3xl font-bold">0</h2>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Produtivo</p>
                        <h2 id="countProd" class="text-3xl font-bold text-emerald-500">0</h2>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Improdutivo</p>
                        <h2 id="countImp" class="text-3xl font-bold text-amber-500">0</h2>
                    </div>
                </div>
                
                
                <div class="bg-white border border-slate-200 rounded-3xl overflow-hidden shadow-sm">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b">
                            <tr>
                                <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase">Assunto / Remetente</th>
                                <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase text-center">Classificação</th>
                                <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase text-center">Data / Hora</th>
                                <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase text-right">Ver mais Detalhes</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody" class="divide-y divide-slate-50"></tbody>
                    </table>
                    
                    <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-between items-center">
                        <span id="pageInfo" class="text-xs text-slate-500 font-medium">Página 1 de 1</span>
                        <div class="flex gap-2">
                            <button onclick="changePage(-1)" id="btnPrev" class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-xs font-bold hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all">Anterior</button>
                            <button onclick="changePage(1)" id="btnNext" class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-xs font-bold hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all">Próximo</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="integration" class="tab-content cursor-not-allowed">
                <header class="mb-8">
                    <h1 class="text-3xl font-bold">Canais de Entrada</h1>
                    <p class="text-slate-500 mt-2">Conecte as caixas de e-mail da empresa para automação em tempo real.</p>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 pointer-events-none">
                    <div class="bg-white border border-slate-200 rounded-3xl p-6 shadow-sm hover:shadow-md transition-all ">
                        <div class="flex justify-between items-start mb-6">
                            <div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center border border-slate-100">
                                <img src="https://www.gstatic.com/images/branding/product/2x/googleg_48dp.png" class="w-6" alt="Google">
                            </div>
                            <span class="bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-1 rounded-full uppercase">Conectado</span>
                        </div>
                        <h3 class="font-bold text-lg">Google Workspace</h3>
                        <p class="text-sm text-slate-500 mb-6">suporte@financeira.com.br</p>
                        <div class="flex items-center justify-between text-xs text-slate-400 border-t pt-4">
                            <span>Última sincronização</span>
                            <span class="font-medium text-slate-600">Agora mesmo</span>
                        </div>
                    </div>

                    <div class="bg-white border border-slate-200 rounded-3xl p-6 shadow-sm hover:shadow-md transition-all">
                        <div class="flex justify-between items-start mb-6">
                            <div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center border border-slate-100">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/4/44/Microsoft_logo.svg" class="w-6" alt="Microsoft">
                            </div>
                            <span class="bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-1 rounded-full uppercase">Conectado</span>
                        </div>
                        <h3 class="font-bold text-lg">Outlook / Office 365</h3>
                        <p class="text-sm text-slate-500 mb-6">contato@financeira.com.br</p>
                        <div class="flex items-center justify-between text-xs text-slate-400 border-t pt-4">
                            <span>Última sincronização</span>
                            <span class="font-medium text-slate-600">Há 5 min</span>
                        </div>
                    </div>

                    <div class="border-2 border-dashed border-slate-200 rounded-3xl p-6 flex flex-col items-center justify-center text-center group hover:border-indigo-300 transition-all cursor-pointer cursor-not-allowed">
                        <div class="w-12 h-12 bg-slate-50 rounded-full flex items-center justify-center mb-4 group-hover:bg-indigo-50 transition-all">
                            <svg class="w-6 h-6 text-slate-400 group-hover:text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                        </div>
                        <span class="font-bold text-slate-600 group-hover:text-indigo-600">Conectar Novo Canal</span>
                        <p class="text-xs text-slate-400 mt-1">IMAP, POP3 ou API Customizada</p>
                    </div>
                </div>

                <div class="mt-12 bg-indigo-900 rounded-3xl p-8 text-white relative overflow-hidden pointer-events-none">
                    <div class="relative z-10 flex flex-col md:flex-row items-center justify-between gap-6">
                        <div>
                            <h2 class="text-2xl font-bold mb-2">Webhooks & API</h2>
                            <p class="text-indigo-200 max-w-md">Integre os resultados da classificação diretamente no seu CRM ou sistema de tickets via Webhook.</p>
                        </div>
                        <button class="bg-white text-indigo-900 px-8 py-3 rounded-xl font-bold hover:bg-indigo-50 transition-all cursor-not-allowed">Configurar Webhook</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

<div id="emailModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col">
        <div class="flex justify-between items-center p-6 border-b bg-white">
            <h2 class="text-xl font-bold text-slate-800">Detalhes da Análise</h2>
            <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 transition-all text-2xl">&times;</button>
        </div>
        
        <div class="p-6 overflow-y-auto space-y-6 bg-white">
            <div class="flex flex-col sm:flex-row items-center gap-6 bg-slate-50 p-6 rounded-2xl border border-slate-100">
                <div id="modalCategoryBadge"></div>
                <div class="flex-1 w-full">
                    <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Confiança da IA</p>
                    <div id="modalConfidence" class="text-2xl font-bold text-slate-800">--%</div>
                    <div class="w-full h-2 bg-slate-200 rounded-full mt-2 overflow-hidden">
                        <div id="confidenceBar" class="h-full bg-indigo-500 transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">De</p>
                    <div id="modalSender" class="text-sm font-semibold text-slate-700">--</div>
                </div>
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Para</p>
                    <div id="modalReceiver" class="text-sm font-semibold text-slate-700">--</div>
                </div>
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Origem do Arquivo</p>
                    <div id="modalFrom" class="text-sm font-medium text-slate-600">--</div>
                </div>
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Data do Processamento</p>
                    <div id="modalDate" class="text-sm font-medium text-slate-600">--</div>
                </div>
            </div>

            <div>
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-2 ml-1">Conteúdo Original</p>
                <div id="modalContent" class="p-4 bg-white border border-slate-200 rounded-xl text-sm text-slate-600 whitespace-pre-wrap leading-relaxed max-h-48 overflow-y-auto"></div>
            </div>

            <div>
                <div class="flex justify-between items-center mb-2 ml-1">
                    <p class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">Sugestão de Resposta</p>
                    <div class="flex gap-4">
                        <button id="btnEditModal" onclick="toggleEditModal()" class="text-[10px] font-bold text-indigo-600 hover:text-indigo-800 transition-all uppercase">Editar</button>
                        <button onclick="copyModalResponse()" class="text-[10px] font-bold text-slate-400 hover:text-slate-600 transition-all uppercase">Copiar</button>
                    </div>
                </div>
                <div id="modalResponse" contenteditable="false" class="p-5 bg-indigo-50 border border-indigo-100 rounded-xl text-sm text-indigo-900 whitespace-pre-wrap leading-relaxed shadow-sm outline-none focus:ring-2 focus:ring-indigo-500 transition-all"></div>
            </div>

            <!-- <div>
                <p class="text-[10px] font-bold text-indigo-400 uppercase mb-2 ml-1 tracking-widest">Sugestão de Resposta</p>
                <div id="modalResponse" class="p-5 bg-indigo-50 border border-indigo-100 rounded-xl text-sm text-indigo-900 whitespace-pre-wrap leading-relaxed shadow-sm"></div>
            </div> -->
        </div>
    </div>
</div>

    <!-- <div id="emailModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b">
                <h2 class="text-xl font-bold">Detalhes da Análise</h2>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600">X</button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6">
                <div class="flex items-center gap-8 bg-slate-50 p-6 rounded-xl">
                    <div id="modalCategoryBadge"></div>
                    <div class="flex-1">
                        <p class="text-xs uppercase font-bold text-slate-400">Confiança IA</p>
                        <div id="modalConfidence" class="text-2xl font-bold">--%</div>
                        <div class="w-full h-2 bg-slate-200 rounded-full mt-2"><div id="confidenceBar" class="h-full bg-indigo-500 rounded-full" style="width: 0%"></div></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-slate-50 rounded-lg"><p class="text-[10px] font-bold text-slate-400 uppercase">Origem</p><div id="modalFrom" class="text-sm font-medium">--</div></div>
                    <div class="p-4 bg-slate-50 rounded-lg"><p class="text-[10px] font-bold text-slate-400 uppercase">Data</p><div id="modalDate" class="text-sm font-medium">--</div></div>
                </div>
                <div><p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Conteúdo Original</p><div id="modalContent" class="p-4 bg-white border rounded-lg text-sm whitespace-pre-line"></div></div>
                <div><p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Sugestão</p><div id="modalResponse" class="p-4 bg-indigo-50 border border-indigo-100 rounded-lg text-sm text-indigo-900"></div></div>
            </div>
        </div>
    </div> -->

<script>
    // ==========================================
    // VARIÁVEIS GLOBAIS DE ESTADO
    // ==========================================
    let currentAnalysisId = null;
    let currentModalItemId = null;
    let isAnalysisComplete = false;
    let currentPage = 1;
    const itemsPerPage = 5;

    // Inicializa o banco de dados na sessão caso não exista
    if (!sessionStorage.getItem('db')) {
        sessionStorage.setItem('db', JSON.stringify([]));
    }

    // ==========================================
    // NOTIFICAÇÕES (TOASTS)
    // ==========================================
    function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        if (!container) return;

        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-emerald-600' : 'bg-red-600';
        
        toast.className = `${bgColor} text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 transform translate-x-full transition-all duration-300 ease-out pointer-events-auto border border-white/10`;
        toast.innerHTML = `
            <span class="text-sm font-bold">${message}</span>
            <button onclick="this.parentElement.remove()" class="text-white/50 hover:text-white">×</button>
        `;
        
        container.appendChild(toast);
        setTimeout(() => toast.classList.remove('translate-x-full'), 10);
        
        setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // ==========================================
    // CONTROLE DE INTERFACE (BOTÕES E TABS)
    // ==========================================
    function updateActionButtonsState() {
        const btnCopy = document.querySelector('button[onclick="copyResponse()"]');
        const btnEdit = document.getElementById('btnEditResponse');
        
        if (!btnCopy || !btnEdit) return;

        if (!isAnalysisComplete) {
            btnCopy.disabled = true;
            btnEdit.disabled = true;
            btnCopy.classList.add('opacity-30', 'cursor-not-allowed');
            btnEdit.classList.add('opacity-30', 'cursor-not-allowed');
        } else {
            btnCopy.disabled = false;
            btnEdit.disabled = false;
            btnCopy.classList.remove('opacity-30', 'cursor-not-allowed');
            btnEdit.classList.remove('opacity-30', 'cursor-not-allowed');
        }
    }

    // ==========================================
    // ANÁLISE PRINCIPAL (CONEXÃO BACKEND)
    // ==========================================
    async function realAnalysis() {
        const btn = document.getElementById('btnAnalisar');
        const input = document.getElementById('analyzeInput');
        const fileInput = document.getElementById('fileInput');
        const resultCard = document.getElementById('resultCard');
        const pulse = document.getElementById('resultPulse');

        if(!input.value && !fileInput.files[0]) return showToast("Insira texto ou anexo para analizar!", "error");

        // UI Loading
        btn.innerText = "IA Processando...";
        btn.disabled = true;
        resultCard.classList.remove('opacity-50');
        pulse.classList.add('animate-ping', 'bg-indigo-500');

        const formData = new FormData();
        if(input.value) formData.append('texto_direto', input.value);
        if(fileInput.files[0]) formData.append('arquivo', fileInput.files[0]);
        
try {
    const response = await fetch('/classificar', { method: 'POST', body: formData });
    const data = await response.json();
    

    // 1. Salvar no Banco da Sessão
    const db = JSON.parse(sessionStorage.getItem('db')) || [];
    const entry = { ...data, id: Date.now(), timestamp: new Date().toLocaleString() };
    db.unshift(entry);
    sessionStorage.setItem('db', JSON.stringify(db));


    // 2. ATIVAÇÃO DOS ESTADOS E BLOQUEIOS
    currentAnalysisId = entry.id;
    isAnalysisComplete = true;

    // Bloqueia o textarea e o label de arquivo
    const textarea = document.getElementById('analyzeInput');
    textarea.disabled = true;
    textarea.classList.add('cursor-not-allowed', 'opacity-50');
    
    document.getElementById('fileInputLabel').classList.add('cursor-not-allowed', 'opacity-50');
    const btnRemove = document.getElementById('btnRemoveFile');
    if (btnRemove) btnRemove.classList.add('hidden');

    // 3. TROCA DE BOTÕES
    document.getElementById('btnAnalisar').classList.add('hidden');
    document.getElementById('btnNovaAnalise').classList.remove('hidden');

    btn.innerText = "Analisar com IA";

    // 4. Atualizar Dashboard e UI
    updateActionButtonsState();
    updateUI(data);
    updateCounts();
    showToast("Análise concluída com sucesso!");

} catch (e) {
    showToast("Erro ao conectar ao servidor", "error");
    // Se der erro, precisamos garantir que o botão de analisar volte ao normal
    const btn = document.getElementById('btnAnalisar');
    btn.innerText = "Analisar com IA";
    btn.disabled = false;
} finally {
    // O finally agora só cuida de parar as animações visuais
    const pulse = document.getElementById('resultPulse');
    if (pulse) pulse.classList.remove('animate-ping');
    
    // NOTA: Não resetamos o texto do botão aqui, 
    // pois o Sucesso ou o Catch já decidiram qual botão exibir.
}
    }

    function updateUI(data) {
        const badge = document.getElementById('categoryBadge');
        const resText = document.getElementById('aiResponseText');
        badge.innerText = data.categoria;
        badge.className = data.categoria === 'PRODUTIVO' ? 
            "px-5 py-2 bg-emerald-500 text-white rounded-full text-xs font-bold" : 
            "px-5 py-2 bg-amber-500 text-white rounded-full text-xs font-bold";
        resText.innerText = data.resposta_sugerida;
        resText.classList.remove('italic', 'text-slate-400');
        resText.classList.add('text-white');
    }

    // ==========================================
    // EDIÇÃO E CÓPIA
    // ==========================================
    function toggleEdit() {
        if (!isAnalysisComplete) return;

        const textDiv = document.getElementById('aiResponseText');
        const btnEdit = document.getElementById('btnEditResponse');
        const isEditable = textDiv.contentEditable === "true";

        if (!isEditable) {
            textDiv.contentEditable = "true";
            textDiv.classList.add('bg-white/10', 'border-indigo-500', 'text-white');
            textDiv.focus();
            btnEdit.innerText = "Salvar Alteração";
            btnEdit.classList.replace('bg-indigo-600', 'bg-emerald-600');
        } else {
            saveEditToStorage(textDiv.innerText); // A função agora está definida abaixo
            textDiv.contentEditable = "false";
            textDiv.classList.remove('border-indigo-500');
            btnEdit.innerText = "Editar Resposta";
            btnEdit.classList.replace('bg-emerald-600', 'bg-indigo-600');
            showToast("Edição salva no histórico!");
        }
    }

    function saveEditToStorage(newText) {
        let db = JSON.parse(sessionStorage.getItem('db')) || [];
        db = db.map(item => {
            if (item.id === currentAnalysisId) {
                return { ...item, resposta_sugerida: newText };
            }
            return item;
        });
        sessionStorage.setItem('db', JSON.stringify(db));
    }

    function copyResponse() {
        if (!isAnalysisComplete) return;
        const text = document.getElementById('aiResponseText').innerText;
        navigator.clipboard.writeText(text).then(() => {
            showToast("Copiado!");
        });
    }

    // ==========================================
    // HISTÓRICO E PAGINAÇÃO
    // ==========================================
    function updateCounts() {
        const db = JSON.parse(sessionStorage.getItem('db'));
        document.getElementById('countTotal').innerText = db.length;
        document.getElementById('countProd').innerText = db.filter(x => x.categoria === 'PRODUTIVO').length;
        document.getElementById('countImp').innerText = db.filter(x => x.categoria === 'IMPRODUTIVO').length;
    }

    function renderHistory() {
        const db = JSON.parse(sessionStorage.getItem('db')) || [];
        const body = document.getElementById('historyBody');
        const totalPages = Math.ceil(db.length / itemsPerPage) || 1;
        
        const start = (currentPage - 1) * itemsPerPage;
        const paginatedItems = db.slice(start, start + itemsPerPage);

        body.innerHTML = paginatedItems.map(item => `
            <tr class="hover:bg-slate-50 transition-all border-b border-slate-50">
                <td class="px-6 py-5"><div class="font-bold text-sm">${item.assunto_resumo}</div><div class="text-xs text-slate-400">${item.remetente || 'Sem remetente'}</div></td>
                <td class="px-6 py-5 text-center"><span class="px-3 py-1 ${item.categoria === 'PRODUTIVO' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'} rounded-lg text-[10px] font-bold uppercase">${item.categoria}</span></td>
                <td class="px-6 py-5 text-center text-xs text-slate-500">${item.timestamp}</td>
                <td class="px-6 py-5 text-right"><button onclick="openDetails(${item.id})" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-indigo-700 transition-colors view-details"><div class="flex flex-row gap-2 justify-center items-center"><svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="20" height="20" viewBox="0,0,256,256" class="icon-vermais">
<g fill="#ffffff" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><g transform="scale(10.66667,10.66667)"><path d="M12,2c-5.51101,0 -10,4.489 -10,10c0,5.511 4.48899,10 10,10c5.51101,0 10,-4.489 10,-10c0,-5.511 -4.48899,-10 -10,-10zM12,4c4.43013,0 8,3.56988 8,8c0,4.43012 -3.56987,8 -8,8c-4.43013,0 -8,-3.56988 -8,-8c0,-4.43012 3.56987,-8 8,-8zM12,7c-0.55228,0 -1,0.44772 -1,1c0,0.55228 0.44772,1 1,1c0.55228,0 1,-0.44772 1,-1c0,-0.55228 -0.44772,-1 -1,-1zM11.98438,10.98633c-0.55152,0.00862 -0.99193,0.46214 -0.98437,1.01367v5c-0.0051,0.36064 0.18438,0.69608 0.49587,0.87789c0.3115,0.18181 0.69676,0.18181 1.00825,0c0.3115,-0.18181 0.50097,-0.51725 0.49587,-0.87789v-5c0.0037,-0.2703 -0.10218,-0.53059 -0.29351,-0.72155c-0.19133,-0.19097 -0.45182,-0.29634 -0.72212,-0.29212z"></path></g></g>
</svg> <div class="hidden_verdetalhes">Ver Detalhes</div></div></button></td>
            </tr>
        `).join('');

        document.getElementById('pageInfo').innerText = `Página ${currentPage} de ${totalPages}`;
        document.getElementById('btnPrev').disabled = (currentPage === 1);
        document.getElementById('btnNext').disabled = (currentPage === totalPages);
    }

    function changePage(direction) {
        currentPage += direction;
        renderHistory();
    }

    // Função openDetails atualizada para capturar o ID
    function openDetails(id) {
        const db = JSON.parse(sessionStorage.getItem('db')) || [];
        const item = db.find(x => x.id === id);
        if (!item) return;

        currentModalItemId = id; 

        // Textos Básicos
        document.getElementById('modalSender').innerText = item.remetente || "Não identificado";
        document.getElementById('modalReceiver').innerText = item.destinatario || "Não identificado";
        document.getElementById('modalFrom').innerText = item.origem;
        document.getElementById('modalDate').innerText = item.timestamp;
        document.getElementById('modalContent').innerText = item.conteudo_original;
        
        // Configuração da Resposta (Modo Leitura)
        const resDiv = document.getElementById('modalResponse');
        resDiv.innerText = item.resposta_sugerida;
        resDiv.contentEditable = "false";
        resDiv.classList.remove('bg-white', 'ring-2');
        document.getElementById('btnEditModal').innerText = "Editar";
        document.getElementById('btnEditModal').classList.remove('text-emerald-600');

        // --- O trecho que recuperamos acima ---
        const badge = document.getElementById('modalCategoryBadge');
        badge.innerHTML = `<span class="px-6 py-2 ${item.categoria === 'PRODUTIVO' ? 'bg-emerald-500' : 'bg-amber-500'} text-white rounded-full text-xs font-bold shadow-lg">${item.categoria}</span>`;

        const confidenceText = document.getElementById('modalConfidence');
        const confidenceBar = document.getElementById('confidenceBar');
        confidenceText.innerText = "0%";
        confidenceBar.style.width = "0%";
        
        setTimeout(() => {
            confidenceText.innerText = item.confianca + "%";
            confidenceBar.style.width = item.confianca + "%";
        }, 150);
        // ---------------------------------------

        // Mostrar Modal
        const modal = document.getElementById('emailModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }
    // FUNÇÃO PARA EDITAR/SALVAR NO MODAL
    function toggleEditModal() {
        const textDiv = document.getElementById('modalResponse');
        const btnEdit = document.getElementById('btnEditModal');
        const isEditable = textDiv.contentEditable === "true";

        if (!isEditable) {
            // Habilitar Edição
            textDiv.contentEditable = "true";
            textDiv.classList.add('bg-white', 'ring-2');
            textDiv.focus();
            btnEdit.innerText = "Salvar";
            btnEdit.classList.add('text-emerald-600');
        } else {
            // Salvar Alteração
            const newText = textDiv.innerText;
            updateDatabaseItem(currentModalItemId, newText);
            
            // Desabilitar Edição
            textDiv.contentEditable = "false";
            textDiv.classList.remove('bg-white', 'ring-2');
            btnEdit.innerText = "Editar";
            btnEdit.classList.remove('text-emerald-600');
            
            showToast("Histórico atualizado!");
        }
    }

    // FUNÇÃO PARA COPIAR TEXTO DO MODAL
    function copyModalResponse() {
        const text = document.getElementById('modalResponse').innerText;
        navigator.clipboard.writeText(text).then(() => {
            showToast("Copiado do modal!");
        });
    }

    // FUNÇÃO AUXILIAR PARA ATUALIZAR O DB
    function updateDatabaseItem(id, newText) {
        let db = JSON.parse(sessionStorage.getItem('db')) || [];
        db = db.map(item => {
            if (item.id === id) {
                return { ...item, resposta_sugerida: newText };
            }
            return item;
        });
        sessionStorage.setItem('db', JSON.stringify(db));
        
        // Se a tabela de histórico estiver visível, atualiza ela também
        if (typeof renderHistory === 'function') renderHistory();
    }


    function closeModal() {
        document.getElementById('emailModal').classList.replace('flex', 'hidden');
    }

    // 1. GERENCIAMENTO DE VALIDAÇÃO CRUZADA
    function handleInputValidation() {
        const textarea = document.getElementById('analyzeInput');
        const fileLabel = document.getElementById('fileInputLabel');
        const fileInput = document.getElementById('fileInput');

        if (textarea.value.trim().length > 0) {
            // Bloqueia anexo se houver texto
            fileLabel.classList.add('opacity-50', 'cursor-not-allowed');
            fileInput.disabled = true;
        } else {
            // Libera anexo se texto for apagado
            fileLabel.classList.remove('opacity-50', 'cursor-not-allowed');
            fileInput.disabled = false;
        }
    }

    // 2. GERENCIAMENTO DE SELEÇÃO DE ARQUIVO
    function handleFileSelection() {
        const fileInput = document.getElementById('fileInput');
        const textarea = document.getElementById('analyzeInput');
        const preview = document.getElementById('filePreview');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const fileLabel = document.getElementById('fileInputLabel');

        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            
            // Exibe o preview e oculta o label de anexo original
            fileNameDisplay.innerText = file.name;
            preview.classList.remove('hidden');
            fileLabel.classList.add('hidden');

            // Bloqueia o textarea
            textarea.disabled = true;
            textarea.classList.add('opacity-50');
            textarea.placeholder = "Remova o arquivo para inserir o texto...";
            
            showToast("Arquivo anexado!");
        }
    }

    // 3. REMOÇÃO DO ARQUIVO
    function removeFile() {
        const fileInput = document.getElementById('fileInput');
        const textarea = document.getElementById('analyzeInput');
        const preview = document.getElementById('filePreview');
        const fileLabel = document.getElementById('fileInputLabel');

        // Limpa o input de arquivo
        fileInput.value = "";
        
        // UI: Volta ao estado original
        preview.classList.add('hidden');
        fileLabel.classList.remove('hidden');
        
        // Libera o textarea
        textarea.disabled = false;
        textarea.classList.remove('opacity-50');
        textarea.placeholder = "Cole o texto do e-mail aqui...";
        
        showToast("Arquivo removido", "success");
    }

function resetAnalysis() {
    // 1. Referências dos elementos
    const btnAnalisar = document.getElementById('btnAnalisar');
    const btnNova = document.getElementById('btnNovaAnalise');
    const textarea = document.getElementById('analyzeInput');
    const fileLabel = document.getElementById('fileInputLabel');
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('filePreview');
    const btnRemove = document.getElementById('btnRemoveFile');

    // 2. Reset de Estados Globais
    isAnalysisComplete = false;
    currentAnalysisId = null;

    // 3. Restaurar Textarea
    textarea.value = "";
    textarea.disabled = false;
    textarea.classList.remove('opacity-50', 'cursor-not-allowed');
    textarea.style.pointerEvents = "auto";
    textarea.placeholder = "Cole o texto do e-mail aqui...";

    // 4. Restaurar Anexo (Limpeza e reativação)
    fileInput.value = ""; 
    fileInput.disabled = false; 
    preview.classList.add('hidden'); // Esconde o preview azul do arquivo anterior
    
    // Garante que o botão de remover volte a ficar visível para quando um NOVO arquivo for selecionado
    if (btnRemove) {
        btnRemove.classList.remove('hidden');
    }

    // Mostra o label tracejado original e remove bloqueios
    fileLabel.classList.remove('hidden', 'cursor-not-allowed', 'opacity-50');
    fileLabel.style.pointerEvents = "auto";
    // fileLabel.style.cursor = "pointer";

    // 5. Alternar Botões principais
    btnNova.classList.add('hidden');
    btnAnalisar.classList.remove('hidden');
    btnAnalisar.innerText = "Analisar com IA";
    btnAnalisar.disabled = false;

    // 6. Reset Visual do Card de Resultado (Mantendo sua identidade)
    const resultCard = document.getElementById('resultCard');
    if (resultCard) resultCard.classList.add('opacity-50');

    const resText = document.getElementById('aiResponseText');
    if (resText) {
        resText.innerText = "O resultado aparecerá aqui...";
        resText.classList.add('italic', 'text-slate-400');
        resText.classList.remove('text-white');
    }
    
    const badge = document.getElementById('categoryBadge');
    if (badge) {
        badge.innerText = "Aguardando entrada...";
        badge.className = "px-5 py-2 bg-slate-800 text-slate-400 rounded-full text-xs font-bold border border-white/10 italic";
    }

    // 7. Sincronizar botões de Copiar/Editar do card
    updateActionButtonsState();

    showToast("Pronto para nova consulta!", "success");
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('overlay').classList.toggle('hidden');
}
function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.sidebar-item').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.getElementById('btn-' + tabId).classList.add('active');
    if(tabId === 'history') renderHistory();
    if(window.innerWidth < 1024) toggleSidebar();
}

    // Inicializar interface
    window.onload = () => {
        updateCounts();
        updateActionButtonsState();
    };
</script>

</body>
</html>